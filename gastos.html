<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación de Gastos de Empresa</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAADwAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADz///8A////AP///wD///8A////AP///wD///8A////AAAAAD8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP//////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA//////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD//////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////////////////////////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////////////////////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD//////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////////////////////////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////////////////////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////////////////////////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAAA8AAAAPAAAADwAAAA8AAAAPAAAADwAAAA8AAAAMA=">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: pan-y;
            overscroll-behavior-y: none;
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .page-content {
            flex-grow: 1;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-xl shadow-md hover:bg-gray-300 transition-colors duration-200;
        }
        .input-text {
            @apply w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500;
        }
        .card {
            @apply bg-white p-6 rounded-3xl shadow-xl transition-transform transform hover:scale-105;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Custom modal styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto;
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 1rem;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="app-container">
        <!-- Vistas de la aplicación -->
        <div id="loadingView" class="loading-overlay hidden">
            <div class="spinner"></div>
        </div>
        
        <div id="projectsView" class="page-content p-4 sm:p-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6">Mis Proyectos de Gastos</h1>
            <p class="text-center text-sm text-gray-500 mb-4">Guardado localmente en este dispositivo.</p>
            <div id="projectsList" class="space-y-4 mb-6">
                <!-- Los proyectos se renderizarán aquí -->
            </div>
            <button id="createProjectBtn" class="btn-primary w-full text-center">Crear Nuevo Proyecto</button>
        </div>

        <div id="newProjectView" class="page-content p-4 sm:p-8 hidden">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6">Nuevo Proyecto</h1>
            <div class="card">
                <input type="text" id="newProjectName" class="input-text mb-4" placeholder="Nombre del Proyecto" />
                <button id="saveNewProjectBtn" class="btn-primary w-full">Guardar Proyecto</button>
            </div>
            <button id="backToProjectsBtn" class="btn-secondary w-full mt-4">Cancelar</button>
        </div>

        <div id="projectDetailView" class="page-content p-4 sm:p-8 hidden">
            <h1 id="projectTitle" class="text-3xl sm:text-4xl font-extrabold text-center mb-6"></h1>
            <div id="expensesList" class="space-y-4 mb-6">
                <!-- Los gastos se renderizarán aquí -->
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="addExpenseBtn" class="btn-primary">Añadir Gasto</button>
                <button id="downloadExcelBtn" class="btn-secondary">Descargar Excel</button>
                <button id="deleteProjectBtn" class="bg-red-500 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-red-600 transition-colors duration-200 col-span-1 sm:col-span-2">Eliminar Proyecto</button>
            </div>
            <button id="backFromProjectBtn" class="btn-secondary w-full mt-4">Volver a Proyectos</button>
        </div>

        <div id="addExpenseView" class="page-content p-4 sm:p-8 hidden">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6">Añadir Nuevo Gasto</h1>
            <div class="card space-y-4">
                <input type="file" id="receiptImageInput" accept="image/*" capture="camera" class="hidden" />
                <button id="captureImageBtn" class="btn-primary w-full mb-4">
                    Tomar Foto del Recibo
                </button>
                <button id="selectImageBtn" class="btn-secondary w-full">
                    Seleccionar Imagen del Dispositivo
                </button>
                <img id="receiptPreview" class="rounded-xl w-full max-h-64 object-contain mx-auto border border-gray-300 hidden" />
                <div id="extractedData" class="space-y-4 hidden">
                    <select id="expenseCategory" class="input-text">
                        <option value="" disabled selected>Selecciona una categoría</option>
                        <option value="OVERSEAS - TRAVEL EXPENSES">OVERSEAS - TRAVEL EXPENSES</option>
                        <option value="LOCAL - TRAVEL EXPENSES">LOCAL - TRAVEL EXPENSES</option>
                        <option value="ENTERTAINMENT">ENTERTAINMENT</option>
                        <option value="OTHERS">OTHERS</option>
                    </select>
                    
                    <div id="categoryFields" class="space-y-4">
                        <!-- Los campos se generarán dinámicamente aquí -->
                    </div>

                    <button id="saveExpenseBtn" class="btn-primary w-full">Guardar Gasto</button>
                </div>
            </div>
            <button id="backFromAddExpenseBtn" class="btn-secondary w-full mt-4">Cancelar</button>
        </div>
    </div>
    
    <!-- Custom Modal for Alerts -->
    <div id="customAlertModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-bold mb-2"></h3>
            <p id="modalMessage" class="mb-4"></p>
            <button id="closeModalBtn" class="btn-primary">Aceptar</button>
        </div>
    </div>

    <script type="module">
        // Configuración inicial
        const CONFIG = {
            API_KEY: "AIzaSyAr0XLuj3QTWA866ezyoJY0JdjA8SInQ_Y", // Reemplaza esto con tu API key real
            STORAGE_KEY: 'gastos_empresa_proyectos',
            EXCEL_TEMPLATE_URL: 'gastos.xlsx',
            API_VERSION: 'v1beta',
            MODEL_NAME: 'gemini-2.5-flash-preview-05-20'
        };

        // Global variables for app state
        let currentProjectId = null;
        let allProjects = [];

        let isEditing = false;
        let editingExpenseIndex = null;

        const categoryFields = {
            'OVERSEAS - TRAVEL EXPENSES': [
                { id: 'date', label: 'Fecha', type: 'date' },
                { id: 'details', label: 'Detalles', type: 'text' },
                { id: 'purchaseOrder', label: 'Purchase Order', type: 'text' },
                { id: 'clientTraining', label: 'Client Training?', type: 'select', options: ['Y', 'N'] },
                { id: 'meals', label: 'Meals', type: 'number' },
                { id: 'accommodation', label: 'Accommodation', type: 'number' },
                { id: 'airfares', label: 'Airfares', type: 'number' },
                { id: 'transport', label: 'Transport', type: 'number' },
                { id: 'other', label: 'Other', type: 'number' },
                { id: 'invoiceMissing', label: 'Invoice Missing?', type: 'checkbox' },
                { id: 'foreignCurrency', label: 'Cost in Foreign Currency', type: 'number' }
            ],
            'LOCAL - TRAVEL EXPENSES': [
                { id: 'date', label: 'Fecha', type: 'date' },
                { id: 'details', label: 'Detalles', type: 'text' },
                { id: 'purchaseOrder', label: 'Purchase Order', type: 'text' },
                { id: 'clientTraining', label: 'Client Training?', type: 'select', options: ['Y', 'N'] },
                { id: 'meals', label: 'Meals', type: 'number' },
                { id: 'accommodation', label: 'Accommodation', type: 'number' },
                { id: 'airfare', label: 'Airfare', type: 'number' },
                { id: 'transport', label: 'Transport', type: 'number' },
                { id: 'other', label: 'Other', type: 'number' },
                { id: 'invoiceMissing', label: 'Invoice Missing?', type: 'checkbox' },
                { id: 'foreignCurrency', label: 'Cost in Foreign Currency', type: 'number' }
            ],
            'ENTERTAINMENT': [
                { id: 'date', label: 'Fecha', type: 'date' },
                { id: 'details', label: 'Detalles (Incluir clientes y nombre de empresa)', type: 'text' },
                { id: 'quantity', label: 'Quantity', type: 'number' },
                { id: 'traveling', label: 'Traveling?', type: 'select', options: ['Y', 'N'] },
                { id: 'place', label: 'Place', type: 'text' },
                { id: 'totalPrice', label: 'Total Price', type: 'number' },
                { id: 'staffMeal', label: 'Staff Meal', type: 'number' },
                { id: 'clientMeal', label: 'Client Meal', type: 'number' },
                { id: 'invoiceMissing', label: 'Invoice Missing?', type: 'checkbox' },
                { id: 'foreignCurrency', label: 'Cost in Foreign Currency', type: 'number' }
            ],
            'OTHERS': [
                { id: 'date', label: 'Fecha', type: 'date' },
                { id: 'details', label: 'Detalles', type: 'text' },
                { id: 'clientTraining', label: 'Client Training?', type: 'select', options: ['Y', 'N'] },
                { id: 'purchaseOrder', label: 'Purchase Order', type: 'text' },
                { id: 'project', label: 'Project', type: 'text' },
                { id: 'totalPrice', label: 'Total Price', type: 'number' },
                { id: 'invoiceMissing', label: 'Invoice Missing?', type: 'checkbox' },
                { id: 'foreignCurrency', label: 'Cost in Foreign Currency', type: 'number' }
            ]
        };

        // --- View Management ---
        const views = {
            projectsView: document.getElementById('projectsView'),
            newProjectView: document.getElementById('newProjectView'),
            projectDetailView: document.getElementById('projectDetailView'),
            addExpenseView: document.getElementById('addExpenseView'),
            loadingView: document.getElementById('loadingView')
        };
        const customAlertModal = document.getElementById('customAlertModal');
        const closeModalBtn = document.getElementById('closeModalBtn');

        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
        }

        function showProjectsView() {
            loadProjects();
            showView('projectsView');
        }

        function showNewProjectView() {
            showView('newProjectView');
            document.getElementById('newProjectName').value = '';
        }

        function showProjectDetailView() {
            showView('projectDetailView');
        }

        function showAddExpenseView(expenseToEdit = null, expenseIndex = null) {
            document.getElementById('receiptPreview').classList.add('hidden');
            document.getElementById('extractedData').classList.remove('hidden');
            
            const saveBtn = document.getElementById('saveExpenseBtn');
            const viewTitle = document.querySelector('#addExpenseView h1');
            
            if (expenseToEdit) {
                isEditing = true;
                editingExpenseIndex = expenseIndex;
                viewTitle.textContent = 'Editar Gasto';
                saveBtn.textContent = 'Guardar Cambios';
                
                // Establecer la categoría
                const categorySelect = document.getElementById('expenseCategory');
                categorySelect.value = expenseToEdit.category;
                categorySelect.dispatchEvent(new Event('change'));
                
                // Esperar a que se generen los campos
                setTimeout(() => {
                    // Rellenar los campos con los datos existentes
                    Object.keys(expenseToEdit).forEach(key => {
                        const element = document.getElementById(key);
                        if (element) {
                            if (element.type === 'checkbox') { // Aquí faltaba un paréntesis de apertura
                                element.checked = expenseToEdit[key];
                            } else {
                                element.value = expenseToEdit[key];
                            }
                        }
                    });
                    
                    // Mostrar la imagen si existe
                    if (expenseToEdit.receiptImage) {
                        document.getElementById('receiptPreview').src = expenseToEdit.receiptImage;
                        document.getElementById('receiptPreview').classList.remove('hidden');
                        document.getElementById('saveExpenseBtn').dataset.imageData = expenseToEdit.receiptImage;
                    }
                }, 100);
            } else {
                isEditing = false;
                editingExpenseIndex = null;
                viewTitle.textContent = 'Añadir Nuevo Gasto';
                saveBtn.textContent = 'Guardar Gasto';
                document.getElementById('expenseCategory').value = '';
                document.getElementById('categoryFields').innerHTML = '';
            }
            
            showView('addExpenseView');
        }

        function showLoading(show) {
            if (show) {
                views.loadingView.classList.remove('hidden');
            } else {
                views.loadingView.classList.add('hidden');
            }
        }
        
        function showAlert(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            customAlertModal.style.display = 'flex';
        }

        closeModalBtn.addEventListener('click', () => {
            customAlertModal.style.display = 'none';
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
        });


        // --- Data Handling (localStorage) ---
        function loadProjects() {
            const storedProjects = localStorage.getItem(CONFIG.STORAGE_KEY);
            allProjects = storedProjects ? JSON.parse(storedProjects) : [];
            renderProjectsList();
        }

        function saveProjects() {
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(allProjects));
        }

        function createProject() {
            const projectName = document.getElementById('newProjectName').value.trim();
            if (!projectName) {
                showAlert("Error", "El nombre del proyecto no puede estar vacío");
                return;
            }
            if (allProjects.some(p => p.name === projectName)) {
                showAlert("Error", "Ya existe un proyecto con ese nombre");
                return;
            }

            const newProject = {
                id: Date.now().toString(),
                name: projectName,
                createdAt: new Date().toISOString(),
                expenses: []
            };

            allProjects.push(newProject);
            saveProjects();
            showProjectsView();
        }

        function addExpenseToProject(expenseData) {
            if (!currentProjectId) {
                console.error("No project selected.");
                return;
            }

            const project = allProjects.find(p => p.id === currentProjectId);
            if (project) {
                project.expenses.push(expenseData);
                saveProjects();
                loadProjectDetails(currentProjectId);
            }
        }

        function editExpense(projectId, expenseIndex, updatedExpenseData) {
            const project = allProjects.find(p => p.id === projectId);
            if (project && project.expenses[expenseIndex]) {
                // Mantener la imagen del recibo si no se proporciona una nueva
                if (!updatedExpenseData.receiptImage) {
                    updatedExpenseData.receiptImage = project.expenses[expenseIndex].receiptImage;
                }
                project.expenses[expenseIndex] = updatedExpenseData;
                saveProjects();
                loadProjectDetails(projectId);
            }
        }

        async function loadProjectDetails(projectId) {
            try {
                if (!projectId) {
                    throw new Error("No project ID provided.");
                }
                currentProjectId = projectId;
                const project = allProjects.find(p => p.id === projectId);
                if (project) {
                    document.getElementById('projectTitle').textContent = project.name;
                    renderExpenses(project.expenses);
                    showProjectDetailView();
                } else {
                    console.error("Project not found.");
                }
            } catch (error) {
                console.error("Error loading project:", error);
                showAlert("Error", "No se pudo cargar el proyecto");
            }
        }

        function deleteProject(projectId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este proyecto y todos sus gastos?')) return;
            allProjects = allProjects.filter(p => p.id !== projectId);
            saveProjects();
            showProjectsView();
        }

        // --- UI Rendering Functions ---
        function renderProjectsList() {
            const list = document.getElementById('projectsList');
            list.innerHTML = '';
            if (allProjects.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">No hay proyectos de gastos. ¡Crea uno!</p>`;
                return;
            }
            allProjects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.classList.add('card');
                projectCard.innerHTML = `
                    <h2 class="text-xl font-semibold">${project.name}</h2>
                    <p class="text-sm text-gray-500">Creado el ${new Date(project.createdAt).toLocaleDateString()}</p>
                `;
                projectCard.addEventListener('click', () => {
                    loadProjectDetails(project.id);
                });
                list.appendChild(projectCard);
            });
        }

        function renderExpenses(expenses) {
            const list = document.getElementById('expensesList');
            list.innerHTML = '';
            if (expenses.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">No hay gastos en este proyecto. ¡Añade uno!</p>`;
                return;
            }
            expenses.forEach(expense => {
                const expenseCard = document.createElement('div');
                expenseCard.classList.add('card');
                
                // Crear contenido HTML basado en la categoría
                let detailsHTML = '';
                switch(expense.category) {
                    case 'OVERSEAS - TRAVEL EXPENSES':
                    case 'LOCAL - TRAVEL EXPENSES':
                        detailsHTML = `
                            <p class="text-sm">Purchase Order: ${expense.purchaseOrder || 'N/A'}</p>
                            <p class="text-sm">Client Training: ${expense.clientTraining || 'N/A'}</p>
                            <p class="text-sm">Meals: $${expense.meals || 0}</p>
                            <p class="text-sm">Accommodation: $${expense.accommodation || 0}</p>
                            <p class="text-sm">Airfares: $${expense.airfares || 0}</p>
                            <p class="text-sm">Transport: $${expense.transport || 0}</p>
                            <p class="text-sm">Other: $${expense.other || 0}</p>
                        `;
                        break;
                    case 'ENTERTAINMENT':
                        detailsHTML = `
                            <p class="text-sm">Quantity: ${expense.quantity || 'N/A'}</p>
                            <p class="text-sm">Traveling: ${expense.traveling || 'N/A'}</p>
                            <p class="text-sm">Place: ${expense.place || 'N/A'}</p>
                            <p class="text-sm">Staff Meal: $${expense.staffMeal || 0}</p>
                            <p class="text-sm">Client Meal: $${expense.clientMeal || 0}</p>
                            <p class="text-sm">Total Price: $${expense.totalPrice || 0}</p>
                        `;
                        break;
                    case 'OTHERS':
                        detailsHTML = `
                            <p class="text-sm">Client Training: ${expense.clientTraining || 'N/A'}</p>
                            <p class="text-sm">Purchase Order: ${expense.purchaseOrder || 'N/A'}</p>
                            <p class="text-sm">Project: ${expense.project || 'N/A'}</p>
                            <p class="text-sm">Total Price: $${expense.totalPrice || 0}</p>
                        `;
                        break;
                }

                expenseCard.innerHTML = `
                    ${expense.receiptImage ? `<img src="${expense.receiptImage}" class="rounded-xl w-full max-h-48 object-contain mb-4" />` : ''}
                    <h3 class="text-lg font-semibold">${expense.details || 'Sin descripción'}</h3>
                    <p class="text-sm font-medium">Fecha: ${expense.date}</p>
                    <p class="text-sm font-medium">Categoría: ${expense.category}</p>
                    <div class="mt-2 space-y-1">
                        ${detailsHTML}
                    </div>
                    <p class="text-sm mt-2">Invoice Missing: ${expense.invoiceMissing ? 'Sí' : 'No'}</p>
                    ${expense.foreignCurrency ? `<p class="text-sm">Foreign Currency: $${expense.foreignCurrency}</p>` : ''}
                    <button class="edit-expense-btn btn-secondary mt-4 w-full text-sm" data-expense-index="${expenses.indexOf(expense)}">
                        Editar Gasto
                    </button>
                `;
                list.appendChild(expenseCard);
            });

            document.querySelectorAll('.edit-expense-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const expenseIndex = parseInt(e.target.dataset.expenseIndex);
                    const project = allProjects.find(p => p.id === currentProjectId);
                    if (project && project.expenses[expenseIndex]) {
                        showAddExpenseView(project.expenses[expenseIndex], expenseIndex);
                    }
                });
            });
        }

        // --- Event Listeners ---
        document.getElementById('createProjectBtn').addEventListener('click', showNewProjectView);
        document.getElementById('saveNewProjectBtn').addEventListener('click', createProject);
        document.getElementById('backToProjectsBtn').addEventListener('click', showProjectsView);
        document.getElementById('backFromProjectBtn').addEventListener('click', showProjectsView);
        document.getElementById('backFromAddExpenseBtn').addEventListener('click', () => loadProjectDetails(currentProjectId));
        document.getElementById('deleteProjectBtn').addEventListener('click', () => deleteProject(currentProjectId));

        document.getElementById('addExpenseBtn').addEventListener('click', showAddExpenseView);

        // Modificar los event listeners para la captura de imagen
        document.getElementById('captureImageBtn').addEventListener('click', () => {
            // Configurar para usar la cámara
            document.getElementById('receiptImageInput').setAttribute('capture', 'environment');
            document.getElementById('receiptImageInput').click();
        });

        document.getElementById('selectImageBtn').addEventListener('click', () => {
            // Quitar el atributo capture para permitir selección de archivo
            document.getElementById('receiptImageInput').removeAttribute('capture');
            document.getElementById('receiptImageInput').click();
        });

        document.getElementById('receiptImageInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                console.log("No se seleccionó ningún archivo");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                showLoading(true);
                try {
                    const base64Image = e.target.result;
                    document.getElementById('receiptPreview').src = base64Image;
                    document.getElementById('receiptPreview').classList.remove('hidden');
                    document.getElementById('saveExpenseBtn').dataset.imageData = base64Image;

                    console.log("Iniciando proceso de IA...");

                    const prompt = `Analiza esta imagen de recibo y responde SOLO con un objeto JSON válido, sin ningún texto adicional ni marcadores.
El JSON debe tener este formato exacto:
{
"date": "YYYY-MM-DD",
"description": "descripción del gasto",
"meals": 0,
"accommodation": 0,
"transport": 0,
"airfares": 0,
"total": 0,
"place": "nombre del establecimiento",
"isOverseas": false
}`;

                    console.log("Preparando payload para API...");
                    const payload = {
                        model: CONFIG.MODEL_NAME,
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inline_data: {
                                        mime_type: file.type,
                                        data: base64Image.split(',')[1]
                                    }
                                }
                            ]
                        }]
                    };

                    const apiUrl = `https://generativelanguage.googleapis.com/${CONFIG.API_VERSION}/models/${CONFIG.MODEL_NAME}:generateContent?key=${CONFIG.API_KEY}`;

                    console.log("Enviando solicitud a API Gemini...");
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Error detallado de la API:", errorData);
                        throw new Error(`Error de la API: ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    console.log("Respuesta de la API:", result);

                    let jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    console.log("Texto recibido de la API:", jsonString);

                    const startIndex = jsonString.indexOf('{');
                    const endIndex = jsonString.lastIndexOf('}');

                    if (startIndex === -1 || endIndex === -1) {
                        throw new Error("No se encontró un objeto JSON válido en la respuesta");
                    }

                    jsonString = jsonString.substring(startIndex, endIndex + 1);
                    console.log("JSON extraído:", jsonString);

                    let parsedData;
                    try {
                        parsedData = JSON.parse(jsonString);
                    } catch (parseError) {
                        console.error("Error al parsear JSON:", parseError, "JSON String:", jsonString);
                        throw new Error("No se pudo procesar la respuesta de la IA: formato JSON inválido.");
                    }

                    console.log("Datos parseados exitosamente:", parsedData);

                    if (!parsedData.date || !parsedData.description) {
                        throw new Error("Faltan datos requeridos en la respuesta de la IA");
                    }

                    let suggestedCategory = 'OTHERS';
                    if (parsedData.airfares > 0 || parsedData.accommodation > 0) {
                        suggestedCategory = parsedData.isOverseas ? 'OVERSEAS - TRAVEL EXPENSES' : 'LOCAL - TRAVEL EXPENSES';
                    } else if (parsedData.meals > 0 && parsedData.place) {
                        suggestedCategory = 'ENTERTAINMENT';
                    }
                    
                    console.log("Categoría sugerida:", suggestedCategory);

                    const categorySelect = document.getElementById('expenseCategory');
                    categorySelect.value = suggestedCategory;
                    categorySelect.dispatchEvent(new Event('change'));

                    setTimeout(() => {
                        // Map AI response keys to form field IDs
                        const keyMap = {
                            description: 'details',
                            total: 'totalPrice'
                        };

                        // Populate fields that have a direct match or a mapped match
                        for (const aiKey in parsedData) {
                            if (Object.hasOwnProperty.call(parsedData, aiKey)) {
                                const formId = keyMap[aiKey] || aiKey;
                                const element = document.getElementById(formId);
                                if (element) {
                                    element.value = parsedData[aiKey];
                                }
                            }
                        }

                        // Handle special case where 'airfares' from AI can map to 'airfare' in the form
                        if (parsedData.airfares && document.getElementById('airfare')) {
                            document.getElementById('airfare').value = parsedData.airfares;
                        }
                    }, 100);

                    showAlert("Éxito", "Datos del recibo auto-rellenados. Por favor, revísalos.");

                } catch (error) {
                    console.error("Error durante el procesamiento de la imagen o la IA:", error);
                    showAlert("Error", `No se pudieron extraer los datos: ${error.message}. Por favor, rellena los campos manualmente.`);
                } finally {
                    showLoading(false);
                    document.getElementById('extractedData').classList.remove('hidden');
                }
            };
            reader.readAsDataURL(file);
        });

    document.getElementById('expenseCategory').addEventListener('change', function(e) {
        const category = e.target.value;
        const fieldsContainer = document.getElementById('categoryFields');
        fieldsContainer.innerHTML = '';

        if (category && categoryFields[category]) {
            categoryFields[category].forEach(field => {
                const fieldDiv = document.createElement('div');
                
                if (field.type === 'select') {
                    fieldDiv.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                        <select id="${field.id}" class="input-text">
                            <option value="" disabled selected>Seleccionar</option>
                            ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                        </select>`;
                } else if (field.type === 'checkbox') {
                    fieldDiv.innerHTML = `
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="${field.id}" class="rounded">
                            <span class="text-sm font-medium text-gray-700">${field.label}</span>
                        </label>`;
                } else {
                    fieldDiv.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                        <input type="${field.type}" id="${field.id}" class="input-text">`;
                }
                
                fieldsContainer.appendChild(fieldDiv);
            });
        }
    });

    // Reemplazar el event listener del saveExpenseBtn:

    document.getElementById('saveExpenseBtn').addEventListener('click', () => {
        const category = document.getElementById('expenseCategory').value;
        if (!category) {
            showAlert("Error", "Por favor selecciona una categoría");
            return;
        }

        const expenseData = {
            category: category,
            receiptImage: document.getElementById('saveExpenseBtn').dataset.imageData || ''
        };

        // Recoger todos los campos según la categoría
        categoryFields[category].forEach(field => {
            const element = document.getElementById(field.id);
            if (!element) return;

            if (field.type === 'checkbox') {
                expenseData[field.id] = element.checked;
            } else if (field.type === 'number') {
                expenseData[field.id] = element.value ? parseFloat(element.value) : 0;
            } else {
                expenseData[field.id] = element.value || '';
            }
        });

        // Validar campos requeridos
        if (!expenseData.date || !expenseData.details) {
            showAlert("Campos Incompletos", "Por favor, completa todos los campos requeridos.");
            return;
        }

        if (isEditing && editingExpenseIndex !== null) {
            editExpense(currentProjectId, editingExpenseIndex, expenseData);
            showAlert("Éxito", "Gasto actualizado correctamente");
        } else {
            addExpenseToProject(expenseData);
            showAlert("Éxito", "Gasto guardado correctamente");
        }
        
        loadProjectDetails(currentProjectId);
    });
        
    // Function to convert Base64 to an ArrayBuffer
    function base64ToArrayBuffer(base64) {
        const binaryString = window.atob(base64.split(',')[1]);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // Download Excel File
    document.getElementById('downloadExcelBtn').addEventListener('click', async () => {
        showLoading(true);

        try {
            const project = allProjects.find(p => p.id === currentProjectId);
            if (!project) throw new Error("Proyecto no encontrado");

            const response = await fetch(CONFIG.EXCEL_TEMPLATE_URL);
            const templateBlob = await response.blob();
            const arrayBuffer = await templateBlob.arrayBuffer();
            
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(arrayBuffer);

            const ccSheet = workbook.getWorksheet("Corporate Credit Card");
            const supportSheet = workbook.getWorksheet("LOCAL TE support doc");
            
            if (!ccSheet) throw new Error("Hoja Corporate Credit Card no encontrada");
            if (!supportSheet) throw new Error("Hoja LOCAL TE support doc no encontrada");

            // Función para encontrar el rango de una categoría
            function findCategoryRange(categoryName) {
                let startRow = null;
                let endRow = null;
                
                // Buscar la categoría en la columna B
                for (let i = 1; i <= ccSheet.rowCount; i++) {
                    const cell = ccSheet.getCell(`B${i}`);
                    
                    if (cell.value === categoryName) {
                        // La fila de datos comienza después de la fila "DATE"
                        startRow = i + 2;
                        
                        // Buscar el final (donde las columnas B, C, D están combinadas)
                        for (let j = startRow; j <= ccSheet.rowCount; j++) {
                            const cellB = ccSheet.getCell(`B${j}`);
                            const cellC = ccSheet.getCell(`C${j}`);
                            const cellD = ccSheet.getCell(`D${j}`);
                            
                            if (cellB.isMerged && cellC.isMerged && cellD.isMerged) {
                                endRow = j - 1;
                                break;
                            }
                        }
                        break;
                    }
                }
                return { startRow, endRow };
            }

            // Función para encontrar la primera fila vacía en un rango
            function findFirstEmptyRow(startRow, endRow) {
                for (let i = startRow; i <= endRow; i++) {
                    const dateCell = ccSheet.getCell(`B${i}`);
                    if (!dateCell.value) {
                        return i;
                    }
                }
                return null;
            }

            // Función para insertar una nueva fila con el formato correcto
            function insertNewRow(afterRowNum) {
                ccSheet.insertRow(afterRowNum + 1, undefined, 'i+');
                
                // Copiar formato y fórmulas de la fila anterior
                const sourceRow = ccSheet.getRow(afterRowNum);
                const newRow = ccSheet.getRow(afterRowNum + 1);
                
                sourceRow.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                    const newCell = newRow.getCell(colNumber);
                    newCell.style = JSON.parse(JSON.stringify(cell.style));
                    if (cell.formula) {
                        newCell.formula = cell.formula;
                    }
                });
                
                return afterRowNum + 1;
            }

            // Función para insertar imagen en la hoja de soporte
            function insertReceiptImage(imageData, rowIndex) {
                if (!imageData) return;
                
                // Encontrar el siguiente espacio disponible
                let imgCol = 1;
                let imgRow = 1;
                const maxImagesPerRow = 2;
                const imageHeight = 300;
                const imageWidth = 400;
                
                // Buscar espacio libre
                const existingImages = supportSheet.getImages();
                if (existingImages.length > 0) {
                    const lastImage = existingImages[existingImages.length - 1];
                    imgCol = lastImage.range.br.col + 1;
                    imgRow = lastImage.range.br.row;
                    
                    if (imgCol > maxImagesPerRow) {
                        imgCol = 1;
                        imgRow = lastImage.range.br.row + imageHeight;
                    }
                }

                const imageId = workbook.addImage({
                    base64: imageData,
                    extension: 'png',
                });

                supportSheet.addImage(imageId, {
                    tl: { col: imgCol, row: imgRow },
                    ext: { width: imageWidth, height: imageHeight }
                });
            }

            // Procesar cada gasto
            for (const expense of project.expenses) {
                const range = findCategoryRange(expense.category);
                if (!range.startRow || !range.endRow) {
                    console.error(`Rango no encontrado para categoría ${expense.category}`);
                    continue;
                }

                let rowToUse = findFirstEmptyRow(range.startRow, range.endRow);
                if (!rowToUse) {
                    rowToUse = insertNewRow(range.endRow);
                }

                const row = ccSheet.getRow(rowToUse);

                // Datos comunes
                row.getCell('B').value = new Date(expense.date);
                row.getCell('C').value = expense.details;

                // Datos específicos por categoría
                switch(expense.category) {
                    case 'OVERSEAS - TRAVEL EXPENSES':
                    case 'LOCAL - TRAVEL EXPENSES':
                        row.getCell('D').value = expense.purchaseOrder;
                        row.getCell('E').value = expense.clientTraining;
                        row.getCell('F').value = Number(expense.meals) || 0;
                        row.getCell('G').value = Number(expense.accommodation) || 0;
                        row.getCell('H').value = Number(expense.airfares || expense.airfare) || 0;
                        row.getCell('I').value = Number(expense.transport) || 0;
                        row.getCell('J').value = Number(expense.other) || 0;
                        row.getCell('K').value = expense.invoiceMissing ? 'X' : '';
                        row.getCell('L').value = Number(expense.foreignCurrency) || 0;
                        break;

                    case 'ENTERTAINMENT':
                        row.getCell('D').value = Number(expense.quantity) || 0;
                        row.getCell('E').value = expense.traveling;
                        row.getCell('F').value = expense.place;
                        row.getCell('G').value = Number(expense.totalPrice) || 0;
                        row.getCell('H').value = Number(expense.staffMeal) || 0;
                        row.getCell('I').value = Number(expense.clientMeal) || 0;
                        row.getCell('K').value = expense.invoiceMissing ? 'X' : '';
                        row.getCell('L').value = Number(expense.foreignCurrency) || 0;
                        break;

                    case 'OTHERS':
                        row.getCell('E').value = expense.clientTraining;
                        row.getCell('F').value = expense.purchaseOrder;
                        row.getCell('G').value = expense.project;
                        row.getCell('H').value = Number(expense.totalPrice) || 0;
                        row.getCell('K').value = expense.invoiceMissing ? 'X' : '';
                        row.getCell('L').value = Number(expense.foreignCurrency) || 0;
                        break;
                }

                // Insertar imagen del recibo si existe
                if (expense.receiptImage) {
                    insertReceiptImage(expense.receiptImage, rowToUse);
                }
            }

            // Guardar el archivo
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.name}_reporte.xlsx`;
            a.click();
            window.URL.revokeObjectURL(url);

            showAlert("Éxito", "Reporte Excel generado correctamente");

        } catch (error) {
            console.error("Error generando Excel:", error);
            showAlert("Error", `No se pudo generar el archivo Excel: ${error.message}`);
        } finally {
            showLoading(false);
        }
    });
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {}
            },
            plugins: [
                function({ addBase, addComponents, addUtilities }) {
                    addComponents({
                        '.btn-primary': {
                            '@apply bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200': {}
                        },
                        '.btn-secondary': {
                            '@apply bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-xl shadow-md hover:bg-gray-300 transition-colors duration-200': {}
                        },
                        '.input-text': {
                            '@apply w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500': {}
                        },
                        '.card': {
                            '@apply bg-white p-6 rounded-3xl shadow-xl transition-transform transform hover:scale-105': {}
                        }
                    })
                }
            ]
        }
    </script>
</body>
</html>
