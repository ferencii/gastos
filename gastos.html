<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación de Gastos de Empresa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: pan-y;
            overscroll-behavior-y: none;
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .page-content {
            flex-grow: 1;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-xl shadow-md hover:bg-gray-300 transition-colors duration-200;
        }
        .input-text {
            @apply w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500;
        }
        .card {
            @apply bg-white p-6 rounded-3xl shadow-xl transition-transform transform hover:scale-105;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Custom modal styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto;
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 1rem;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="app-container">
        <!-- Vistas de la aplicación -->
        <div id="loadingView" class="loading-overlay hidden">
            <div class="spinner"></div>
        </div>
        
        <div id="projectsView" class="page-content p-4 sm:p-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6">Mis Proyectos de Gastos</h1>
            <p class="text-center text-sm text-gray-500 mb-4">Guardado localmente en este dispositivo.</p>
            <div id="projectsList" class="space-y-4 mb-6">
                <!-- Los proyectos se renderizarán aquí -->
            </div>
            <button id="createProjectBtn" class="btn-primary w-full text-center">Crear Nuevo Proyecto</button>
        </div>

        <div id="newProjectView" class="page-content p-4 sm:p-8 hidden">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6">Nuevo Proyecto</h1>
            <div class="card">
                <input type="text" id="newProjectName" class="input-text mb-4" placeholder="Nombre del Proyecto" />
                <button id="saveNewProjectBtn" class="btn-primary w-full">Guardar Proyecto</button>
            </div>
            <button id="backToProjectsBtn" class="btn-secondary w-full mt-4">Cancelar</button>
        </div>

        <div id="projectDetailView" class="page-content p-4 sm:p-8 hidden">
            <h1 id="projectTitle" class="text-3xl sm:text-4xl font-extrabold text-center mb-6"></h1>
            <div id="expensesList" class="space-y-4 mb-6">
                <!-- Los gastos se renderizarán aquí -->
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button id="addExpenseBtn" class="btn-primary">Añadir Gasto</button>
                <button id="downloadExcelBtn" class="btn-secondary">Descargar Excel</button>
                <button id="deleteProjectBtn" class="bg-red-500 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-red-600 transition-colors duration-200 col-span-1 sm:col-span-2">Eliminar Proyecto</button>
            </div>
            <button id="backFromProjectBtn" class="btn-secondary w-full mt-4">Volver a Proyectos</button>
        </div>

        <div id="addExpenseView" class="page-content p-4 sm:p-8 hidden">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6">Añadir Nuevo Gasto</h1>
            <div class="card space-y-4">
                <input type="file" id="receiptImageInput" accept="image/*" capture="camera" class="hidden" />
                <button id="captureImageBtn" class="btn-primary w-full mb-4">
                    Tomar Foto del Recibo
                </button>
                <button id="selectImageBtn" class="btn-secondary w-full">
                    Seleccionar Imagen del Dispositivo
                </button>
                <img id="receiptPreview" class="rounded-xl w-full max-h-64 object-contain mx-auto border border-gray-300 hidden" />
                <div id="extractedData" class="space-y-4 hidden">
                    <select id="expenseCategory" class="input-text">
                        <option value="" disabled selected>Selecciona una categoría</option>
                        <option value="OVERSEAS - TRAVEL EXPENSES">OVERSEAS - TRAVEL EXPENSES</option>
                        <option value="LOCAL - TRAVEL EXPENSES">LOCAL - TRAVEL EXPENSES</option>
                        <option value="ENTERTAINMENT">ENTERTAINMENT</option>
                        <option value="OTHERS">OTHERS</option>
                    </select>
                    
                    <div id="categoryFields" class="space-y-4">
                        <!-- Los campos se generarán dinámicamente aquí -->
                    </div>

                    <button id="saveExpenseBtn" class="btn-primary w-full">Guardar Gasto</button>
                </div>
            </div>
            <button id="backFromAddExpenseBtn" class="btn-secondary w-full mt-4">Cancelar</button>
        </div>
    </div>
    
    <!-- Custom Modal for Alerts -->
    <div id="customAlertModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-bold mb-2"></h3>
            <p id="modalMessage" class="mb-4"></p>
            <button id="closeModalBtn" class="btn-primary">Aceptar</button>
        </div>
    </div>

    <script type="module">
        // Global variables for app state
        let currentProjectId = null;
        let allProjects = [];

        const STORAGE_KEY = 'gastos_empresa_proyectos';
        const EXCEL_TEMPLATE_URL = 'gastos.xlsx';

        const categoryFields = {
            'OVERSEAS - TRAVEL EXPENSES': [
                { id: 'date', label: 'Fecha', type: 'date' },
                { id: 'details', label: 'Detalles', type: 'text' },
                { id: 'purchaseOrder', label: 'Purchase Order', type: 'text' },
                { id: 'clientTraining', label: 'Client Training?', type: 'select', options: ['Y', 'N'] },
                { id: 'meals', label: 'Meals', type: 'number' },
                { id: 'accommodation', label: 'Accommodation', type: 'number' },
                { id: 'airfares', label: 'Airfares', type: 'number' },
                { id: 'transport', label: 'Transport', type: 'number' },
                { id: 'other', label: 'Other', type: 'number' },
                { id: 'invoiceMissing', label: 'Invoice Missing?', type: 'checkbox' },
                { id: 'foreignCurrency', label: 'Cost in Foreign Currency', type: 'number' }
            ],
            'LOCAL - TRAVEL EXPENSES': [
                { id: 'date', label: 'Fecha', type: 'date' },
                { id: 'details', label: 'Detalles', type: 'text' },
                { id: 'purchaseOrder', label: 'Purchase Order', type: 'text' },
                { id: 'clientTraining', label: 'Client Training?', type: 'select', options: ['Y', 'N'] },
                { id: 'meals', label: 'Meals', type: 'number' },
                { id: 'accommodation', label: 'Accommodation', type: 'number' },
                { id: 'airfare', label: 'Airfare', type: 'number' },
                { id: 'transport', label: 'Transport', type: 'number' },
                { id: 'other', label: 'Other', type: 'number' },
                { id: 'invoiceMissing', label: 'Invoice Missing?', type: 'checkbox' },
                { id: 'foreignCurrency', label: 'Cost in Foreign Currency', type: 'number' }
            ],
            'ENTERTAINMENT': [
                { id: 'date', label: 'Fecha', type: 'date' },
                { id: 'details', label: 'Detalles (Incluir clientes y nombre de empresa)', type: 'text' },
                { id: 'quantity', label: 'Quantity', type: 'number' },
                { id: 'traveling', label: 'Traveling?', type: 'select', options: ['Y', 'N'] },
                { id: 'place', label: 'Place', type: 'text' },
                { id: 'totalPrice', label: 'Total Price', type: 'number' },
                { id: 'staffMeal', label: 'Staff Meal', type: 'number' },
                { id: 'clientMeal', label: 'Client Meal', type: 'number' },
                { id: 'invoiceMissing', label: 'Invoice Missing?', type: 'checkbox' },
                { id: 'foreignCurrency', label: 'Cost in Foreign Currency', type: 'number' }
            ],
            'OTHERS': [
                { id: 'date', label: 'Fecha', type: 'date' },
                { id: 'details', label: 'Detalles', type: 'text' },
                { id: 'clientTraining', label: 'Client Training?', type: 'select', options: ['Y', 'N'] },
                { id: 'purchaseOrder', label: 'Purchase Order', type: 'text' },
                { id: 'project', label: 'Project', type: 'text' },
                { id: 'totalPrice', label: 'Total Price', type: 'number' },
                { id: 'invoiceMissing', label: 'Invoice Missing?', type: 'checkbox' },
                { id: 'foreignCurrency', label: 'Cost in Foreign Currency', type: 'number' }
            ]
        };

        // --- View Management ---
        const views = {
            projectsView: document.getElementById('projectsView'),
            newProjectView: document.getElementById('newProjectView'),
            projectDetailView: document.getElementById('projectDetailView'),
            addExpenseView: document.getElementById('addExpenseView'),
            loadingView: document.getElementById('loadingView')
        };
        const customAlertModal = document.getElementById('customAlertModal');
        const closeModalBtn = document.getElementById('closeModalBtn');

        function showView(viewName) {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
        }

        function showProjectsView() {
            loadProjects();
            showView('projectsView');
        }

        function showNewProjectView() {
            showView('newProjectView');
            document.getElementById('newProjectName').value = '';
        }

        function showProjectDetailView() {
            showView('projectDetailView');
        }

        function showAddExpenseView() {
            document.getElementById('receiptPreview').classList.add('hidden');
            document.getElementById('extractedData').classList.remove('hidden'); // Show form for manual input
            showView('addExpenseView');
        }

        function showLoading(show) {
            if (show) {
                views.loadingView.classList.remove('hidden');
            } else {
                views.loadingView.classList.add('hidden');
            }
        }
        
        function showAlert(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            customAlertModal.style.display = 'flex';
        }

        closeModalBtn.addEventListener('click', () => {
            customAlertModal.style.display = 'none';
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
        });


        // --- Data Handling (localStorage) ---
        function loadProjects() {
            const storedProjects = localStorage.getItem(STORAGE_KEY);
            allProjects = storedProjects ? JSON.parse(storedProjects) : [];
            renderProjectsList();
        }

        function saveProjects() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allProjects));
        }

        function createProject() {
            const projectName = document.getElementById('newProjectName').value;
            if (!projectName.trim()) return;

            const newProject = {
                id: Date.now().toString(),
                name: projectName,
                createdAt: new Date().toISOString(),
                expenses: []
            };

            allProjects.push(newProject);
            saveProjects();
            showProjectsView();
        }

        function addExpenseToProject(expenseData) {
            if (!currentProjectId) {
                console.error("No project selected.");
                return;
            }

            const project = allProjects.find(p => p.id === currentProjectId);
            if (project) {
                project.expenses.push(expenseData);
                saveProjects();
                loadProjectDetails(currentProjectId);
            }
        }

        function loadProjectDetails(projectId) {
            if (!projectId) {
                console.error("No project ID provided.");
                return;
            }
            currentProjectId = projectId;
            const project = allProjects.find(p => p.id === projectId);
            if (project) {
                document.getElementById('projectTitle').textContent = project.name;
                renderExpenses(project.expenses);
                showProjectDetailView();
            } else {
                console.error("Project not found.");
            }
        }

        function deleteProject(projectId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este proyecto y todos sus gastos?')) return;
            allProjects = allProjects.filter(p => p.id !== projectId);
            saveProjects();
            showProjectsView();
        }

        // --- UI Rendering Functions ---
        function renderProjectsList() {
            const list = document.getElementById('projectsList');
            list.innerHTML = '';
            if (allProjects.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">No hay proyectos de gastos. ¡Crea uno!</p>`;
                return;
            }
            allProjects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.classList.add('card');
                projectCard.innerHTML = `
                    <h2 class="text-xl font-semibold">${project.name}</h2>
                    <p class="text-sm text-gray-500">Creado el ${new Date(project.createdAt).toLocaleDateString()}</p>
                `;
                projectCard.addEventListener('click', () => {
                    loadProjectDetails(project.id);
                });
                list.appendChild(projectCard);
            });
        }

        function renderExpenses(expenses) {
            const list = document.getElementById('expensesList');
            list.innerHTML = '';
            if (expenses.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">No hay gastos en este proyecto. ¡Añade uno!</p>`;
                return;
            }
            expenses.forEach(expense => {
                const expenseCard = document.createElement('div');
                expenseCard.classList.add('card');
                expenseCard.innerHTML = `
                    <img src="${expense.receiptImage}" class="rounded-xl w-full max-h-48 object-contain mb-4" />
                    <h3 class="text-lg font-semibold">${expense.description || 'Sin descripción'}</h3>
                    <p class="text-sm">Fecha: ${expense.date}</p>
                    <p class="text-sm">Importe: $${expense.amount}</p>
                    <p class="text-sm">Categoría: ${expense.category}</p>
                `;
                list.appendChild(expenseCard);
            });
        }

        // --- Event Listeners ---
        document.getElementById('createProjectBtn').addEventListener('click', showNewProjectView);
        document.getElementById('saveNewProjectBtn').addEventListener('click', createProject);
        document.getElementById('backToProjectsBtn').addEventListener('click', showProjectsView);
        document.getElementById('backFromProjectBtn').addEventListener('click', showProjectsView);
        document.getElementById('backFromAddExpenseBtn').addEventListener('click', () => loadProjectDetails(currentProjectId));
        document.getElementById('deleteProjectBtn').addEventListener('click', () => deleteProject(currentProjectId));

        document.getElementById('addExpenseBtn').addEventListener('click', showAddExpenseView);

        // Modificar los event listeners para la captura de imagen
        document.getElementById('captureImageBtn').addEventListener('click', () => {
            // Configurar para usar la cámara
            document.getElementById('receiptImageInput').setAttribute('capture', 'environment');
            document.getElementById('receiptImageInput').click();
        });

        document.getElementById('selectImageBtn').addEventListener('click', () => {
            // Quitar el atributo capture para permitir selección de archivo
            document.getElementById('receiptImageInput').removeAttribute('capture');
            document.getElementById('receiptImageInput').click();
        });

        document.getElementById('receiptImageInput').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                document.getElementById('receiptPreview').src = base64Image;
                document.getElementById('receiptPreview').classList.remove('hidden');
                document.getElementById('saveExpenseBtn').dataset.imageData = base64Image;

                showLoading(true);

                try {
                    const prompt = `Actúa como un asistente para informes de gastos. Analiza la siguiente imagen de un recibo y extrae:
                        - fecha (formato YYYY-MM-DD)
                        - descripción detallada
                        - importes desglosados si los hay (meals, accommodation, transport, etc.)
                        - importe total
                        - lugar o establecimiento
                        Responde con un objeto JSON con estas claves. Si no encuentras algún dato, usa cadena vacía o 0.`;

                    const payload = {
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inlineData: {
                                        mimeType: file.type,
                                        data: base64Image.split(',')[1] 
                            }
                        }
                    ]
                }]
            };

            const apiKey = "AIzaSyAr0XLuj3QTWA866ezyoJY0JdjA8SInQ_Y"; // Reemplazar con tu API key de Google
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error('API request failed');
            }

            const result = await response.json();
            const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
            const parsedData = JSON.parse(jsonString);

            // Inferir la categoría basada en los datos
            let suggestedCategory = '';
            if (parsedData.airfares > 0 || parsedData.accommodation > 0) {
                suggestedCategory = parsedData.isOverseas ? 'OVERSEAS - TRAVEL EXPENSES' : 'LOCAL - TRAVEL EXPENSES';
            } else if (parsedData.meals > 0 && parsedData.place.toLowerCase().includes('restaurant')) {
                suggestedCategory = 'ENTERTAINMENT';
            } else {
                suggestedCategory = 'OTHERS';
            }

            // Establecer la categoría sugerida
            const categorySelect = document.getElementById('expenseCategory');
            categorySelect.value = suggestedCategory;
            // Disparar el evento change para generar los campos
            categorySelect.dispatchEvent(new Event('change'));

            // Esperar a que los campos se generen
            setTimeout(() => {
                // Rellenar los campos según la categoría
                const fields = categoryFields[suggestedCategory];
                fields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (element) {
                        switch (field.id) {
                            case 'date':
                                element.value = parsedData.date;
                                break;
                            case 'details':
                                element.value = parsedData.description;
                                break;
                            case 'place':
                                element.value = parsedData.place;
                                break;
                            case 'totalPrice':
                                element.value = parsedData.total;
                                break;
                            case 'meals':
                                element.value = parsedData.meals || 0;
                                break;
                            case 'accommodation':
                                element.value = parsedData.accommodation || 0;
                                break;
                            case 'transport':
                                element.value = parsedData.transport || 0;
                                break;
                            case 'airfares':
                            case 'airfare':
                                element.value = parsedData.airfares || 0;
                                break;
                            default:
                                if (parsedData[field.id] !== undefined) {
                                    element.value = parsedData[field.id];
                                }
                        }
                    }
                });
            }, 100);

            showAlert("Éxito", "Datos del recibo auto-rellenados. Por favor, revísalos.");

        } catch (error) {
            console.error("Error processing image with AI:", error);
            showAlert("Error", "No se pudieron extraer los datos del recibo. Por favor, rellena los campos manualmente.");
        } finally {
            showLoading(false);
            document.getElementById('extractedData').classList.remove('hidden');
        }
    };
    reader.readAsDataURL(file);
});

document.getElementById('expenseCategory').addEventListener('change', function(e) {
    const category = e.target.value;
    const fieldsContainer = document.getElementById('categoryFields');
    fieldsContainer.innerHTML = '';

    if (category && categoryFields[category]) {
        categoryFields[category].forEach(field => {
            const fieldDiv = document.createElement('div');
            
            if (field.type === 'select') {
                fieldDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                    <select id="${field.id}" class="input-text">
                        <option value="" disabled selected>Seleccionar</option>
                        ${field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>`;
            } else if (field.type === 'checkbox') {
                fieldDiv.innerHTML = `
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="${field.id}" class="rounded">
                        <span class="text-sm font-medium text-gray-700">${field.label}</span>
                    </label>`;
            } else {
                fieldDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
                    <input type="${field.type}" id="${field.id}" class="input-text">`;
            }
            
            fieldsContainer.appendChild(fieldDiv);
        });
    }
});

// Modificar la función saveExpenseBtn para recoger todos los campos
document.getElementById('saveExpenseBtn').addEventListener('click', () => {
    const category = document.getElementById('expenseCategory').value;
    if (!category) {
        showAlert("Error", "Por favor selecciona una categoría");
        return;
    }

    const expenseData = {
        category: category,
        receiptImage: document.getElementById('saveExpenseBtn').dataset.imageData || ''
    };

    // Recoger todos los campos según la categoría
    categoryFields[category].forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            if (field.type === 'checkbox') {
                expenseData[field.id] = element.checked;
            } else {
                expenseData[field.id] = element.value;
            }
        }
    });

    // Validar campos requeridos
    if (!expenseData.date || !expenseData.details) {
        showAlert("Campos Incompletos", "Por favor, completa todos los campos requeridos.");
        return;
    }

    addExpenseToProject(expenseData);
});
        
// Function to convert Base64 to an ArrayBuffer
function base64ToArrayBuffer(base64) {
    const binaryString = window.atob(base64.split(',')[1]);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

// Download Excel File
document.getElementById('downloadExcelBtn').addEventListener('click', async () => {
    showLoading(true);

    try {
        // Obtener el proyecto actual
        const project = allProjects.find(p => p.id === currentProjectId);
        if (!project) throw new Error("Proyecto no encontrado");

        // 1. Primero obtener el archivo template como blob
        const response = await fetch(EXCEL_TEMPLATE_URL);
        if (!response.ok) throw new Error('No se pudo cargar el template');
        const templateBlob = await response.blob();
        
        // 2. Crear una copia del archivo
        const newBlob = templateBlob.slice(0, templateBlob.size, templateBlob.type);
        const arrayBuffer = await newBlob.arrayBuffer();
        
        // 3. Cargar el workbook
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(arrayBuffer);

        // 4. Modificar solo los valores sin tocar las fórmulas
        const ccSheet = workbook.getWorksheet("Corporate Credit Card");
        if (ccSheet) {
            // Función auxiliar para encontrar el rango de filas de cada categoría
            const findCategoryRange = (categoryName) => {
                let startRow = null;
                let endRow = null;
                
                // Buscar la categoría en la columna B
                for (let row = 1; row <= ccSheet.rowCount; row++) {
                    const cellValue = ccSheet.getCell(row, 2).value; // Columna B
                    
                    if (cellValue === categoryName) {
                        // La fila de datos empieza 2 filas después del título de la categoría (saltando "DATE")
                        startRow = row + 2;
                        
                        // Buscar el final (donde hay celdas combinadas o la siguiente categoría)
                        for (let r = startRow; r <= ccSheet.rowCount; r++) {
                            const cell = ccSheet.getCell(r, 2);
                            if (cell.isMerged || ['OVERSEAS - TRAVEL EXPENSES', 'LOCAL - TRAVEL EXPENSES', 'ENTERTAINMENT', 'OTHERS'].includes(cell.value)) {
                                endRow = r - 1;
                                break;
                            }
                        }
                        break;
                    }
                }
                return { startRow, endRow };
            };

            // Procesar cada gasto según su categoría
            const processedExpenses = {};
            project.expenses.forEach(expense => {
                if (!processedExpenses[expense.category]) {
                    processedExpenses[expense.category] = [];
                }
                processedExpenses[expense.category].push(expense);
            });

            // Procesar cada categoría
            for (const [category, expenses] of Object.entries(processedExpenses)) {
                const range = findCategoryRange(category);
                if (!range.startRow || !range.endRow) continue;

                // Encontrar la primera fila vacía en la categoría
                let currentRow = range.startRow;
                let templateRow = range.startRow; // Guardar una fila template para copiar

                expenses.forEach(expense => {
                    // Si no hay más filas disponibles, crear una nueva
                    if (currentRow > range.endRow) {
                        // Copiar la fila template con su formato y fórmulas
                        const newRow = ccSheet.addRow([], currentRow);
                        const sourceRow = ccSheet.getRow(templateRow);
                        
                        // Copiar formato y fórmulas
                        newRow.height = sourceRow.height;
                        sourceRow.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                            const newCell = newRow.getCell(colNumber);
                            newCell.style = JSON.parse(JSON.stringify(cell.style));
                            if (cell.formula) {
                                newCell.formula = cell.formula;
                            }
                        });
                    }

                    const row = ccSheet.getRow(currentRow);
                    
                    // Insertar datos básicos
                    row.getCell(1).value = new Date(expense.date);
                    row.getCell(2).value = expense.description;

                    // Insertar monto en la columna correcta según la categoría
                    switch(category) {
                        case 'OVERSEAS - TRAVEL EXPENSES':
                            row.getCell(9).value = Number(expense.amount);
                            break;
                        case 'LOCAL - TRAVEL EXPENSES':
                            row.getCell(4).value = Number(expense.amount);
                            break;
                        case 'ENTERTAINMENT':
                            row.getCell(5).value = Number(expense.amount);
                            break;
                        case 'OTHERS':
                            row.getCell(9).value = Number(expense.amount);
                            break;
                    }

                    currentRow++;
                });
            }
        }

        // 5. Guardar el archivo
        const buffer = await workbook.xlsx.writeBuffer({
            filename: `${project.name}_reporte.xlsx`,
            useStyles: true,
            useSharedStrings: true
        });

        const blob = new Blob([buffer], { 
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${project.name}_reporte.xlsx`;
        a.click();
        window.URL.revokeObjectURL(url);

    } catch (error) {
        console.error("Error generando Excel:", error);
        showAlert("Error", `No se pudo generar el archivo Excel: ${error.message}`);
    } finally {
        showLoading(false);
    }
});
    </script>
</body>
</html>
